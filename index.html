<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Chat</title>
  <link rel="manifest" href="/manifest.json" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;color:#222;height:100vh;margin:0;display:flex;flex-direction:column;transition:.2s}
    .dark{background:#121212;color:#eee}
    #calculator{display:none;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#111;color:white}
    #calc-display{width:220px;padding:10px;font-size:1.5rem;margin-bottom:10px;text-align:right;border:none;border-radius:6px;}
    .calc-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;width:220px}
    .calc-buttons button{padding:15px;font-size:1.2rem;border:none;border-radius:8px;background:#333;color:white;cursor:pointer}
    .calc-buttons button:hover{background:#555}

    #onlineBox{font-size:13px;padding:8px 10px;color:gray;border-bottom:1px solid rgba(0,0,0,0.05)}
    #chatBox{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column}
    .message{margin:6px 0;padding:8px 10px;border-radius:8px;background:#e8e8e8;max-width:80%;align-self:flex-start}
    .self{background:#0078ff;color:#fff;align-self:flex-end}
    .meta{font-size:11px;opacity:.7;margin-top:6px;text-align:right}
    #typing{font-size:13px;color:gray;padding:6px 10px}
    #inputBox{display:flex;padding:10px;background:#eaeaea}
    #messageInput{flex:1;padding:8px;border-radius:6px;border:1px solid #ccc}
    button{padding:8px 12px;margin-left:6px;border:none;border-radius:6px;background:#0078ff;color:#fff;cursor:pointer}
    #emergencyBtn{background:#d32f2f}
  </style>
</head>
<body>
  <!-- Calculator Gate -->
  <div id="calculator">
    <input type="text" id="calc-display" readonly />
    <div class="calc-buttons">
      <button onclick="press(1)">1</button>
      <button onclick="press(2)">2</button>
      <button onclick="press(3)">3</button>
      <button onclick="press('+')">+</button>
      <button onclick="press(4)">4</button>
      <button onclick="press(5)">5</button>
      <button onclick="press(6)">6</button>
      <button onclick="press('-')">-</button>
      <button onclick="press(7)">7</button>
      <button onclick="press(8)">8</button>
      <button onclick="press(9)">9</button>
      <button onclick="press('*')">*</button>
      <button onclick="press(0)">0</button>
      <button onclick="clearDisplay()">C</button>
      <button onclick="checkPassword()">=</button>
      <button onclick="press('/')">/</button>
    </div>
  </div>

  <!-- Actual Chat -->
  <div id="chatUI" style="display:none;">
    <div id="onlineBox">Checking online...</div>
    <div id="chatBox"></div>
    <div id="typing"></div>
    <div id="inputBox">
      <input id="messageInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
      <button id="clearBtn">Clear</button>
      <button id="emergencyBtn">üö®</button>
      <button id="toggleBtn">üåô</button>
    </div>
  </div>

  <script type="module">
    // ---------- CALCULATOR LOCK ----------
    const calculator = document.getElementById('calculator');
    const chatUI = document.getElementById('chatUI');
    const display = document.getElementById('calc-display');
    const PASS = "0304";

    function press(val){ display.value += val; }
    function clearDisplay(){ display.value = ''; }
    function checkPassword(){
      if (display.value === PASS){
        calculator.style.display='none';
        chatUI.style.display='flex';
        localStorage.setItem('unlocked','true');
      } else {
        alert('Wrong code!');
        clearDisplay();
      }
    }

    // Show calculator on load if not unlocked
    window.addEventListener('load', ()=>{
      if(localStorage.getItem('unlocked')==='true') chatUI.style.display='flex';
      else calculator.style.display='flex';
    });

    // On back/reload ‚Äî always show calculator again
    window.addEventListener('pageshow',()=>{
      if(localStorage.getItem('unlocked')!=='true'){
        calculator.style.display='flex';
        chatUI.style.display='none';
      }
    });

    // ---------- CHAT (your same working Firebase code) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getDatabase, ref, push, onValue, set, onDisconnect, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import {
      getMessaging, getToken, onMessage
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBQmP2YgChWdkUyOyR5msGoog68KzNjDlk",
      authDomain: "chat-ab2b7.firebaseapp.com",
      databaseURL: "https://chat-ab2b7-default-rtdb.firebaseio.com/",
      projectId: "chat-ab2b7",
      storageBucket: "chat-ab2b7.firebasestorage.app",
      messagingSenderId: "978470856109",
      appId: "1:978470856109:web:b8e64269b09ffd5225ed24"
    };
    const VAPID_KEY = "BBbBHQbrOZ_5abtXJaW8rzmrolFvZ0Nq5NAwk_DQ5jIVXjJttzHsKwAAKx8uEPj5yQ2I3pAeW8Kr4Y1b3vDh9wA";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messaging = getMessaging(app);

    const onlineBox = document.getElementById("onlineBox");
    const chatBox = document.getElementById("chatBox");
    const typingDiv = document.getElementById("typing");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const emergencyBtn = document.getElementById("emergencyBtn");
    const toggleBtn = document.getElementById("toggleBtn");

    let username = localStorage.getItem("username");
    if (!username) {
      username = prompt("Enter your name:") || ("User" + Math.floor(Math.random()*999));
      localStorage.setItem("username", username);
    }

    // Presence
    const presenceRef = ref(db, 'presence/' + username);
    async function setOnline() {
      await set(presenceRef, { online: true, lastActive: serverTimestamp() });
      onDisconnect(presenceRef).set({ online: false, lastActive: serverTimestamp() });
    }
    setOnline();
    onValue(ref(db, 'presence'), snap => {
      const data = snap.val() || {};
      const onlineNames = [];
      for (const n in data){ if(data[n].online) onlineNames.push(n); }
      onlineBox.textContent = onlineNames.length ? 'üü¢ Online: '+onlineNames.join(', ') : 'No one online';
    });

    // Messages
    sendBtn.addEventListener('click', () => {
      const text = input.value.trim();
      if (!text) return;
      push(ref(db, 'messages'), {
        sender: username, text, ts: Date.now(), time: new Date().toLocaleTimeString()
      });
      input.value = '';
    });

    onValue(ref(db, 'messages'), snap => {
      chatBox.innerHTML = '';
      const data = snap.val() || {};
      Object.values(data).sort((a,b)=>a.ts-b.ts).forEach(msg=>{
        const el = document.createElement('div');
        el.className = 'message' + (msg.sender===username?' self':'');
        el.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text}<div class="meta">${msg.time||''}</div>`;
        chatBox.appendChild(el);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Clear chat locally
    clearBtn.addEventListener('click',()=>{
      if(confirm('Clear chat locally?')){
        localStorage.setItem('chatClearedAt', Date.now());
        chatBox.innerHTML='';
      }
    });

    // Emergency
    emergencyBtn.addEventListener('click',()=>{
      push(ref(db,'messages'),{
        sender:'‚ö†Ô∏è System',
        text:`${username} pressed the EMERGENCY button!`,
        ts:Date.now(),
        time:new Date().toLocaleTimeString()
      });
      localStorage.removeItem('unlocked');
      chatUI.style.display='none';
      calculator.style.display='flex';
      window.open('https://pw.live','_blank');
    });

    // Dark mode
    toggleBtn.addEventListener('click',()=>{
      document.body.classList.toggle('dark');
      toggleBtn.textContent=document.body.classList.contains('dark')?'‚òÄÔ∏è':'üåô';
    });
  </script>
</body>
</html>
