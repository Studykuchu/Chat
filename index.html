<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculatorr</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f4f4f4;
      color: #222;
      height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #calculator, #chatContainer { width: 320px; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); overflow: hidden; }
    #display { width: 100%; height: 60px; font-size: 24px; text-align: right; padding: 10px; border: none; background: #222; color: #0f0; }
    .keys { display: grid; grid-template-columns: repeat(4, 1fr); }
    .keys button { font-size: 20px; padding: 20px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; }
    .keys button:hover { background: #ddd; }
    .hidden { display: none !important; }

    /* Chat UI */
    #chatContainer { display: flex; flex-direction: column; height: 500px; }
    #onlineBox { font-size: 13px; padding: 8px 10px; color: gray; border-bottom: 1px solid rgba(0,0,0,0.05); }
    #lastSeen { font-size: 12px; color: #777; font-style: italic; padding: 0 10px 4px; }
    #chatBox { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
    .message { margin: 6px 0; padding: 8px 10px; border-radius: 8px; background: #e8e8e8; max-width: 80%; align-self: flex-start; position: relative; }
    .self { background: #0078ff; color: #fff; align-self: flex-end; }
    .meta { font-size: 11px; opacity: .7; margin-top: 4px; text-align: right; }
    #typing { font-size: 13px; color: gray; padding: 6px 10px; }
    #inputBox { display: flex; padding: 10px; background: #eaeaea; }
    #messageInput { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    button { padding: 8px 12px; margin-left: 6px; border: none; border-radius: 6px; background: #0078ff; color: #fff; cursor: pointer; }
    #emergencyBtn { background: #d32f2f; }
  </style>
</head>
<body>
  <!-- Calculator -->
  <div id="calculator">
    <input id="display" readonly />
    <div class="keys">
      <button>7</button><button>8</button><button>9</button><button>/</button>
      <button>4</button><button>5</button><button>6</button><button>*</button>
      <button>1</button><button>2</button><button>3</button><button>-</button>
      <button>0</button><button>.</button><button id="clearCalc">C</button><button>+</button>
      <button id="equals" style="grid-column: span 4; background:#0078ff;color:#fff;">=</button>
    </div>
  </div>

  <!-- Chat -->
  <div id="chatContainer" class="hidden">
    <div id="onlineBox">Checking online...</div>
    <div id="lastSeen"></div>
    <div id="chatBox"></div>
    <div id="typing"></div>
    <div id="inputBox">
      <input id="messageInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
      <button id="clearBtn">Clear</button>
      <button id="emergencyBtn">ðŸš¨</button>
    </div>
  </div>

  <script type="module">
    // Calculator logic
    const display = document.getElementById("display");
    const keys = document.querySelectorAll(".keys button");
    const calc = document.getElementById("calculator");
    const chatContainer = document.getElementById("chatContainer");
    const equals = document.getElementById("equals");
    const clearCalc = document.getElementById("clearCalc");
    let secret = "";

    keys.forEach(btn => {
      btn.addEventListener("click", () => {
        const val = btn.textContent;
        if (val === "=") {
          if (secret === "0304") {
            calc.classList.add("hidden");
            chatContainer.classList.remove("hidden");
          } else {
            try {
              display.value = eval(display.value);
            } catch { display.value = "Error"; }
          }
          secret = "";
        } else if (val === "C") {
          display.value = "";
          secret = "";
        } else {
          display.value += val;
          secret += val;
          if (secret.length > 4) secret = secret.slice(-4);
        }
      });
    });

    clearCalc.addEventListener("click", () => { display.value = ""; secret = ""; });

    // Firebase Chat Logic
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBQmP2YgChWdkUyOyR5msGoog68KzNjDlk",
      authDomain: "chat-ab2b7.firebaseapp.com",
      databaseURL: "https://chat-ab2b7-default-rtdb.firebaseio.com/",
      projectId: "chat-ab2b7",
      storageBucket: "chat-ab2b7.firebasestorage.app",
      messagingSenderId: "978470856109",
      appId: "1:978470856109:web:b8e64269b09ffd5225ed24"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const onlineBox = document.getElementById("onlineBox");
    const chatBox = document.getElementById("chatBox");
    const typingDiv = document.getElementById("typing");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const emergencyBtn = document.getElementById("emergencyBtn");
    const lastSeenDiv = document.getElementById("lastSeen");

    let username = localStorage.getItem("username");
    if (!username) {
      username = prompt("Enter your name:") || ("User" + Math.floor(Math.random()*999));
      localStorage.setItem("username", username);
    }

    // Presence
    const presenceRef = ref(db, "presence/" + username);
    async function setOnline() {
      await set(presenceRef, { online: true, lastActive: Date.now() });
      onDisconnect(presenceRef).set({ online: false, lastActive: Date.now() });
    }
    setOnline();

    onValue(ref(db,'presence'), snap => {
      const data = snap.val() || {};
      const others = Object.keys(data).filter(k => k !== username);
      if (others.length === 0) {
        onlineBox.textContent = "Waiting for someone...";
        lastSeenDiv.textContent = "";
        return;
      }
      const onlineNames = others.filter(n => data[n] && data[n].online);
      if (onlineNames.length > 0) onlineBox.textContent = "ðŸŸ¢ Online: " + onlineNames.join(", ");
      else onlineBox.textContent = "No one online";

      let lastUser = null, lastTime = 0;
      for (const u of others) {
        const info = data[u];
        if (info && info.lastActive && info.lastActive > lastTime) {
          lastTime = info.lastActive; lastUser = u;
        }
      }
      if (lastUser && lastTime) lastSeenDiv.textContent = "Last seen (" + lastUser + "): " + time12(lastTime);
      else lastSeenDiv.textContent = "";
    });

    function time12(ts) {
      const d = new Date(ts);
      let h = d.getHours(), m = d.getMinutes();
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12 || 12;
      return `${h}:${m.toString().padStart(2, "0")} ${ampm}`;
    }

    // Typing
    let typingTimeout;
    input.addEventListener("input", () => {
      set(ref(db, "typing/" + username), true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => set(ref(db, "typing/" + username), false), 1200);
    });
    onValue(ref(db, "typing"), snap => {
      const data = snap.val() || {};
      const others = Object.keys(data).filter(n => n !== username && data[n]);
      typingDiv.textContent = others.length ? `${others.join(", ")} is typing...` : "";
    });

    // Send message
    sendBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      push(ref(db, "messages"), { sender: username, text, ts: Date.now(), seen: false });
      input.value = "";
      set(ref(db, "typing/" + username), false);
    });

    // Clear local
    clearBtn.addEventListener("click", () => {
      if (!confirm("Clear chat locally?")) return;
      localStorage.setItem("chatClearedAt", Date.now());
      chatBox.innerHTML = "";
    });

    // Emergency
    emergencyBtn.addEventListener("click", () => {
      push(ref(db, "messages"), { sender: "âš ï¸ System", text: username + " pressed EMERGENCY!", ts: Date.now() });
      localStorage.setItem("chatClearedAt", Date.now());
      chatBox.innerHTML = "";
      window.open("https://www.google.com/search?q=calculator", "_blank");
    });

    // Display messages + seen ticks
    onValue(ref(db, "messages"), snap => {
      const clearedAt = Number(localStorage.getItem("chatClearedAt") || 0);
      const data = snap.val() || {};
      chatBox.innerHTML = "";
      const list = Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a,b)=>a.ts-b.ts);
      for (const msg of list) {
        if (msg.ts <= clearedAt) continue;
        const div = document.createElement("div");
        div.className = "message" + (msg.sender === username ? " self" : "");
        let ticks = "";
        if (msg.sender === username) ticks = msg.seen ? "âœ“âœ“" : "âœ“";
        div.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text}<div class="meta">${time12(msg.ts)} ${ticks}</div>`;
        chatBox.appendChild(div);
      }
      chatBox.scrollTop = chatBox.scrollHeight;

      // Mark others' messages as seen
      for (const msg of list) {
        if (msg.sender !== username && !msg.seen) {
          set(ref(db, "messages/" + msg.id + "/seen"), true);
        }
      }
    });
  </script>
</body>
</html>
