<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculatorr</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
    body{background:#f4f4f4;display:flex;align-items:center;justify-content:center;min-height:100vh}
    #calculator{width:320px;padding:18px;background:#000;border-radius:16px;display:grid;grid-template-columns:repeat(4,1fr);grid-gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    #calc-display{grid-column:1/5;background:#111;color:#0f0;padding:14px;border-radius:10px;font-size:28px;text-align:right;min-height:56px;overflow:hidden}
    .btn{height:64px;border-radius:12px;border:none;background:#333;color:#fff;font-size:20px;cursor:pointer}
    .btn:hover{background:#444}
    .op{background:#ff9500}
    .op:hover{background:#ffa733}
    #equal{background:#0078ff}
    #clearCalc{background:#d32f2f}
    #chatContainer{display:none;width:360px;height:640px;border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.2);background:#fff;flex-direction:column}
    #onlineBox{background:#0078ff;color:#fff;padding:10px;font-size:14px}
    #lastSeen{padding:6px 10px;font-size:13px;color:#333;background:#f1f7ff}
    #chatBox{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#fafafa}
    .message{max-width:78%;padding:10px;border-radius:10px;background:#eee;align-self:flex-start;word-wrap:break-word}
    .self{background:#0078ff;color:white;align-self:flex-end}
    .meta{font-size:11px;color:rgba(0,0,0,0.6);margin-top:6px;text-align:right}
    .ticks{margin-left:6px;font-size:12px;opacity:.85}
    img.chat-img{max-width:200px;border-radius:8px;margin-top:4px;cursor:pointer;transition:transform .2s}
    img.chat-img:hover{transform:scale(1.03)}
    #typing{padding:6px 12px;color:#666;font-size:13px;height:20px}
    #inputRow{display:flex;align-items:center;gap:6px;padding:8px;background:#fff;border-top:1px solid #eee;flex-wrap:nowrap}
    #messageInput{flex:1;padding:9px;border-radius:8px;border:1px solid #ccc;font-size:14px}
    #sendBtn,#clearBtn,#emergencyBtn{padding:9px 12px;border-radius:8px;border:none;background:#0078ff;color:#fff;cursor:pointer;flex-shrink:0}
    #clearBtn{background:#9e9e9e;color:#000}
    #emergencyBtn{background:#d32f2f;font-weight:bold}
    #attachBtn{background:#555;color:#fff;border:none;border-radius:8px;padding:9px;cursor:pointer}
    #imageFullscreen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);align-items:center;justify-content:center;z-index:1000;flex-direction:column}
    #imageFullscreen img{max-width:90%;max-height:85%;border-radius:12px;box-shadow:0 0 20px rgba(255,255,255,0.3)}
    #closeFullscreen{margin-top:20px;padding:10px 18px;border:none;border-radius:8px;background:#d32f2f;color:#fff;font-size:16px;cursor:pointer}
  </style>
</head>
<body>

  <div id="calculator">
    <div id="calc-display"></div>
    <button class="btn">7</button><button class="btn">8</button><button class="btn">9</button><button class="btn op">/</button>
    <button class="btn">4</button><button class="btn">5</button><button class="btn">6</button><button class="btn op">*</button>
    <button class="btn">1</button><button class="btn">2</button><button class="btn">3</button><button class="btn op">-</button>
    <button class="btn">0</button><button class="btn">.</button><button class="btn" id="equal">=</button><button class="btn op">+</button>
    <button class="btn" id="clearCalc">C</button>
  </div>

  <div id="chatContainer">
    <div id="onlineBox">Checking online...</div>
    <div id="lastSeen"></div>
    <div id="chatBox"></div>
    <div id="typing"></div>
    <div id="inputRow">
      <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
      <button id="attachBtn">ðŸ“Ž</button>
      <button id="sendBtn">Send</button>
      <button id="emergencyBtn">ðŸš¨</button>
      <button id="clearBtn">Clear</button>
    </div>
  </div>

  <div id="imageFullscreen">
    <img id="fullscreenImg" src="">
    <button id="closeFullscreen">Exit Fullscreen</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBQmP2YgChWdkUyOyR5msGoog68KzNjDlk",
      authDomain: "chat-ab2b7.firebaseapp.com",
      databaseURL: "https://chat-ab2b7-default-rtdb.firebaseio.com/",
      projectId: "chat-ab2b7",
      storageBucket: "chat-ab2b7.appspot.com", // âœ… Fixed
      messagingSenderId: "978470856109",
      appId: "1:978470856109:web:b8e64269b09ffd5225ed24"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const calcDisplay = document.getElementById('calc-display');
    const calculator = document.getElementById('calculator');
    const chatContainer = document.getElementById('chatContainer');
    const chatBox = document.getElementById('chatBox');
    const equalBtn = document.getElementById('equal');
    const buttons = document.querySelectorAll('.btn');
    const clearCalc = document.getElementById('clearCalc');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const attachBtn = document.getElementById('attachBtn');
    const clearBtn = document.getElementById('clearBtn');
    const emergencyBtn = document.getElementById('emergencyBtn');
    const fullscreen = document.getElementById('imageFullscreen');
    const fullscreenImg = document.getElementById('fullscreenImg');
    const closeFullscreen = document.getElementById('closeFullscreen');
    const onlineBox = document.getElementById('onlineBox');
    const lastSeenDiv = document.getElementById('lastSeen');
    const typingDiv = document.getElementById('typing');

    const SECRET = "0304";
    let calcValue = "";

    let username = localStorage.getItem("username");
    if (!username) {
      username = prompt("Enter your name:") || "User" + Math.floor(Math.random() * 999);
      localStorage.setItem("username", username);
    }

    function formatTime(ts) {
      const d = new Date(ts);
      let h = d.getHours();
      const m = d.getMinutes().toString().padStart(2, "0");
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12 || 12;
      return `${h}:${m} ${ampm}`;
    }

    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        const v = btn.textContent;
        if (v === "C") { calcValue = ""; calcDisplay.textContent = ""; return; }
        if (v === "=") {
          if (calcValue === SECRET) {
            calculator.style.display = "none";
            chatContainer.style.display = "flex";
            attachChat();
            return;
          }
          try { calcValue = String(eval(calcValue)); calcDisplay.textContent = calcValue; }
          catch { calcDisplay.textContent = "Error"; calcValue = ""; }
          return;
        }
        calcValue += v;
        calcDisplay.textContent = calcValue;
      });
    });

    clearCalc.addEventListener("click", () => { calcValue = ""; calcDisplay.textContent = ""; });

    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "image/*";
    fileInput.style.display = "none";
    document.body.appendChild(fileInput);
    attachBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", uploadImage);

    closeFullscreen.addEventListener("click", () => fullscreen.style.display = "none");

    async function uploadImage(e) {
      const file = e.target.files[0];
      if (!file) return;
      const fileRef = sRef(storage, "chatImages/" + Date.now() + "_" + file.name);
      await uploadBytes(fileRef, file);
      const url = await getDownloadURL(fileRef);
      const msgRef = push(ref(db, "messages"));
      set(msgRef, { sender: username, imageURL: url, ts: Date.now(), time: formatTime(Date.now()) });
      e.target.value = "";
    }

    function attachChat() {
      onValue(ref(db, "messages"), snap => {
        const data = snap.val() || {};
        chatBox.innerHTML = "";
        Object.values(data).sort((a,b)=>a.ts-b.ts).forEach(m => {
          const div = document.createElement("div");
          div.className = "message" + (m.sender === username ? " self" : "");
          if (m.imageURL) {
            div.innerHTML = `<strong>${m.sender}:</strong><br><img src="${m.imageURL}" class="chat-img"><div class="meta">${m.time}</div>`;
            div.querySelector("img").addEventListener("click", () => {
              fullscreenImg.src = m.imageURL;
              fullscreen.style.display = "flex";
            });
          } else {
            div.innerHTML = `<strong>${m.sender}:</strong> ${m.text || ""}<div class="meta">${m.time}</div>`;
          }
          chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });
    clearBtn.addEventListener("click", () => chatBox.innerHTML = "");
    emergencyBtn.addEventListener("click", () => {
      chatContainer.style.display = "none";
      calculator.style.display = "grid";
      calcValue = ""; calcDisplay.textContent = "";
    });

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      const msgRef = push(ref(db, "messages"));
      set(msgRef, { sender: username, text, ts: Date.now(), time: formatTime(Date.now()) });
      messageInput.value = "";
    }
  </script>
</body>
</html>mg src="${m.imageURL}" class="chat-img"><div class="meta">${m.time||''}<span class="ticks">${ticks}</span></div></div>`;
            const img=el.querySelector('img');
            img.addEventListener('click',()=>{
              fullscreenImg.src=m.imageURL;
              fullscreen.style.display='flex';
            });
          } else {
            el.innerHTML=`<div><strong>${m.sender}:</strong> ${m.text}</div><div class="meta">${m.time||''}<span class="ticks">${ticks}</span></div>`;
          }
          chatBox.appendChild(el);
        }
        chatBox.scrollTop=chatBox.scrollHeight;
      });
    }

    function detachChatListeners(){
      off(ref(db,'presence'));
      off(ref(db,'typing'));
      off(ref(db,'messages'));
      messagesListener=typingListener=presenceListener=null;
    }

    messageInput.addEventListener('input',()=>{
      set(ref(db,'typing/'+username),messageInput.value.trim()!=='');
    });

    sendBtn.addEventListener('click',sendMessage);
    messageInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage();});

    function sendMessage(){
      const text=messageInput.value.trim();
      if(!text)return;
      const msgRef=push(ref(db,'messages'));
      set(msgRef,{sender:username,text,ts:Date.now(),time:time12(Date.now()),delivered:false,seenBy:{[username]:true}});
      messageInput.value='';
      set(ref(db,'typing/'+username),false);
    }

    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const fileRef = sRef(storage, 'chatImages/'+Date.now()+'_'+file.name);
      await uploadBytes(fileRef, file);
      const url = await getDownloadURL(fileRef);
      const msgRef = push(ref(db,'messages'));
      set(msgRef,{sender:username,imageURL:url,ts:Date.now(),time:time12(Date.now()),delivered:false,seenBy:{[username]:true}});
      e.target.value='';
    });

    clearBtn.addEventListener('click',()=>{chatBox.innerHTML='';});
    emergencyBtn.addEventListener('click',()=>{
      detachChatListeners();
      chatBox.innerHTML='';
      chatContainer.style.display='none';
      calculator.style.display='grid';
      calcValue='';calcDisplay.textContent='';
    });

    document.title='Calculatorr';
  </script>
</body>
</html>
