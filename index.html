<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hidden Calculator Chat</title>
<style>
  body {font-family:sans-serif;margin:0;background:#111;color:#eee;display:flex;justify-content:center;align-items:center;height:100vh;}
  #calc,#chat{width:320px;background:#222;border-radius:12px;overflow:hidden;box-shadow:0 0 20px #0008;}
  #display{background:#000;color:#0f0;font-size:2em;padding:20px;text-align:right;}
  .btns{display:grid;grid-template-columns:repeat(4,1fr);}
  button{font-size:1.2em;padding:20px;border:1px solid #333;background:#333;color:#fff;cursor:pointer;}
  button:hover{background:#444;}
  #chat{display:none;flex-direction:column;height:480px;}
  #messages{flex:1;overflow-y:auto;padding:10px;background:#111;}
  .msg{margin:4px 0;padding:6px 8px;border-radius:8px;}
  .mine{background:#064;}
  .theirs{background:#333;}
  #inputRow{display:flex;}
  #msgInput{flex:1;padding:10px;background:#222;color:#fff;border:none;}
  #sendBtn{background:#06c;border:none;padding:10px;color:#fff;cursor:pointer;}
  #topbar{background:#000;padding:8px;text-align:center;position:relative;}
  #emergency{position:absolute;right:8px;top:8px;background:#900;color:#fff;border:none;padding:4px 8px;cursor:pointer;}
  small{color:#aaa;font-size:0.7em;}
</style>
</head>
<body>
<div id="calc">
  <div id="display">0</div>
  <div class="btns">
    <button>7</button><button>8</button><button>9</button><button>/</button>
    <button>4</button><button>5</button><button>6</button><button>*</button>
    <button>1</button><button>2</button><button>3</button><button>-</button>
    <button>0</button><button>.</button><button id="equals">=</button><button>+</button>
  </div>
</div>

<div id="chat">
  <div id="topbar">
    <span id="status">Connecting...</span>
    <button id="emergency">Emergency</button>
  </div>
  <div id="messages"></div>
  <div id="inputRow">
    <input id="msgInput" placeholder="Type a message" />
    <button id="sendBtn">Send</button>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script>
/* ==== 1.  YOUR FIREBASE CONFIG  ==== */
const firebaseConfig = {
  apiKey: "AIzaSyBQmP2YgChWdkUyOyR5msGoog68KzNjDlk",
  authDomain: "chat-ab2b7.firebaseapp.com",
  databaseURL: "https://chat-ab2b7-default-rtdb.firebaseio.com",
  projectId: "chat-ab2b7",
  storageBucket: "chat-ab2b7.firebasestorage.app",
  messagingSenderId: "978470856109",
  appId: "1:978470856109:web:b8e64269b09ffd5225ed24",
  measurementId: "G-S46Z82JYKW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* ==== 2.  GLOBALS  ==== */
const display = document.getElementById('display');
const buttons = document.querySelectorAll('.btns button');
const calcDiv = document.getElementById('calc');
const chatDiv = document.getElementById('chat');
const messagesDiv = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const statusSpan = document.getElementById('status');
const emergencyBtn = document.getElementById('emergency');

let expr = '', name = localStorage.getItem('chat_name'), uid=null;
const secret = '0304';

/* ==== 3.  ASK NAME  ==== */
if(!name){
  name = prompt('Enter your name:') || 'Anonymous';
  localStorage.setItem('chat_name', name);
}

/* ==== 4.  Calculator  ==== */
buttons.forEach(b=>{
  b.onclick=()=>{
    const val=b.textContent;
    if(val==='=') {
      if(expr===secret) openChat();
      else {
        try{ display.textContent=eval(expr) }catch{ display.textContent='Err' }
        expr='';
      }
    } else {
      expr+=val;
      display.textContent=expr;
    }
  };
});

/* ==== 5.  Chat + Firebase ==== */
auth.signInAnonymously().catch(console.error);
auth.onAuthStateChanged(u=>{
  if(!u) return;
  uid=u.uid;
  const presRef=db.ref('presence/'+uid);
  presRef.set({name,online:true,lastSeen:Date.now()});
  presRef.onDisconnect().set({name,online:false,lastSeen:Date.now()});
  db.ref('presence').on('value',snap=>{
    const val=snap.val()||{};
    const onlineUsers=Object.values(val).filter(p=>p.online&&p.name!==name);
    const onlineNames=onlineUsers.map(o=>o.name).join(', ')||'No one online';
    statusSpan.textContent='Online: '+onlineNames;
  });
  db.ref('messages').on('child_added',snap=>{
    const m=snap.val();
    addMsg(m);
  });
});

function sendMsg(){
  const t=msgInput.value.trim();
  if(!t) return;
  const m={name,uid,text:t,time:Date.now()};
  db.ref('messages').push(m);
  msgInput.value='';
}
sendBtn.onclick=sendMsg;
msgInput.onkeydown=e=>{if(e.key==='Enter')sendMsg();};

function addMsg(m){
  const div=document.createElement('div');
  div.className='msg '+(m.uid===uid?'mine':'theirs');
  div.innerHTML=`<b>${m.name}</b>: ${m.text}<br><small>${new Date(m.time).toLocaleTimeString()}</small>`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

/* ==== 6.  Emergency ==== */
emergencyBtn.onclick=()=>{
  chatDiv.style.display='none';
  calcDiv.style.display='block';
  messagesDiv.innerHTML='';
  display.textContent='0';
};

/* ==== 7.  Secret toggle ==== */
function openChat(){
  calcDiv.style.display='none';
  chatDiv.style.display='flex';
}

/* ==== 8.  Always start with calculator ==== */
window.addEventListener('load', ()=>{
  chatDiv.style.display='none';
  calcDiv.style.display='block';
});
window.addEventListener('popstate', ()=>{
  chatDiv.style.display='none';
  calcDiv.style.display='block';
});
</script>
</body>
</html>
