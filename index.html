<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hidden Chat Calculator</title>
  <style>
    body { font-family: Arial; background: #111; color: #fff; text-align: center; margin: 0; }
    #calc, #chat { width: 320px; margin: 40px auto; background: #222; border-radius: 8px; padding: 10px; }
    #display { background: #000; color: #0f0; padding: 15px; font-size: 1.5em; text-align: right; border-radius: 5px; margin-bottom: 10px; }
    .btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
    button { padding: 15px; font-size: 1.2em; background: #333; color: #fff; border: none; border-radius: 5px; }
    button:hover { background: #555; }

    #chat { display: none; height: 500px; display: flex; flex-direction: column; }
    #messages { flex: 1; overflow-y: auto; background: #000; padding: 10px; text-align: left; }
    .msg { background: #333; padding: 6px; border-radius: 5px; margin: 4px 0; }
    .mine { background: #065535; }
    #inputRow { display: flex; margin-top: 5px; }
    #msgInput { flex: 1; padding: 10px; background: #111; color: #fff; border: none; }
    #sendBtn { background: #06f; border: none; color: #fff; padding: 10px 15px; }
    #status { font-size: 0.9em; margin-bottom: 5px; }
    #emergency { background: red; color: #fff; border: none; padding: 5px 10px; margin-top: 5px; border-radius: 4px; }
  </style>
</head>
<body>

<!-- Calculator -->
<div id="calc">
  <div id="display">0</div>
  <div class="btns">
    <button>7</button><button>8</button><button>9</button><button>/</button>
    <button>4</button><button>5</button><button>6</button><button>*</button>
    <button>1</button><button>2</button><button>3</button><button>-</button>
    <button>0</button><button>.</button><button id="equals">=</button><button>+</button>
  </div>
</div>

<!-- Chat -->
<div id="chat">
  <div id="status">Connecting...</div>
  <div id="messages"></div>
  <div id="inputRow">
    <input id="msgInput" placeholder="Type message...">
    <button id="sendBtn">Send</button>
  </div>
  <button id="emergency">Emergency</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBQmP2YgChWdkUyOyR5msGoog68KzNjDlk",
  authDomain: "chat-ab2b7.firebaseapp.com",
  databaseURL: "https://chat-ab2b7-default-rtdb.firebaseio.com",
  projectId: "chat-ab2b7",
  storageBucket: "chat-ab2b7.firebasestorage.app",
  messagingSenderId: "978470856109",
  appId: "1:978470856109:web:b8e64269b09ffd5225ed24",
  measurementId: "G-S46Z82JYKW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const calc = document.getElementById("calc");
const chat = document.getElementById("chat");
const display = document.getElementById("display");
const buttons = document.querySelectorAll(".btns button");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const messagesDiv = document.getElementById("messages");
const statusDiv = document.getElementById("status");
const emergency = document.getElementById("emergency");

let expr = "";
let uid = null;
let name = localStorage.getItem("chat_name") || prompt("Enter your name:") || "Anonymous";
localStorage.setItem("chat_name", name);
const secret = "0304";

// Calculator
buttons.forEach(b => {
  b.onclick = () => {
    const v = b.textContent;
    if (v === "=") {
      if (expr === secret) {
        openChat();
      } else {
        try { display.textContent = eval(expr) } catch { display.textContent = "Err" }
        expr = "";
      }
    } else {
      expr += v;
      display.textContent = expr;
    }
  };
});

// Chat
auth.signInAnonymously().then(u => {
  uid = u.user.uid;
  const presenceRef = db.ref("presence/" + uid);
  presenceRef.set({ name, online: true, lastSeen: Date.now() });
  presenceRef.onDisconnect().set({ name, online: false, lastSeen: Date.now() });

  db.ref("presence").on("value", snap => {
    const data = snap.val() || {};
    const online = Object.values(data).filter(p => p.online && p.name !== name).map(p => p.name).join(", ");
    statusDiv.textContent = online ? "Online: " + online : "No one online";
  });

  db.ref("messages").on("child_added", s => {
    const m = s.val();
    const div = document.createElement("div");
    div.className = "msg " + (m.uid === uid ? "mine" : "");
    div.innerHTML = `<b>${m.name}</b>: ${m.text}<br><small>${new Date(m.time).toLocaleTimeString()}</small>`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
});

sendBtn.onclick = sendMessage;
msgInput.onkeydown = e => { if (e.key === "Enter") sendMessage(); };

function sendMessage() {
  const text = msgInput.value.trim();
  if (!text) return;
  db.ref("messages").push({ name, uid, text, time: Date.now() });
  msgInput.value = "";
}

emergency.onclick = () => {
  chat.style.display = "none";
  calc.style.display = "block";
  messagesDiv.innerHTML = "";
  display.textContent = "0";
};

function openChat() {
  calc.style.display = "none";
  chat.style.display = "flex";
}

// always go back to calculator on reload
window.addEventListener("load", () => {
  chat.style.display = "none";
  calc.style.display = "block";
});
</script>

</body>
</html>
