<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculatorr</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;color:#222;height:100vh;margin:0;display:flex;flex-direction:column;transition:.2s}
    .dark{background:#121212;color:#eee}
    #onlineBox{font-size:13px;padding:8px 10px;color:gray;border-bottom:1px solid rgba(0,0,0,0.05)}
    #lastSeen{font-size:12px;color:#666;padding:2px 10px;margin-bottom:4px}
    #chatBox{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column}
    .message{margin:6px 0;padding:8px 10px;border-radius:8px;background:#e8e8e8;max-width:80%;align-self:flex-start}
    .self{background:#0078ff;color:#fff;align-self:flex-end}
    .meta{font-size:11px;opacity:.8;margin-top:4px;text-align:right}
    #typing{font-size:13px;color:gray;padding:6px 10px}
    #inputBox{display:flex;padding:10px;background:#eaeaea}
    #messageInput{flex:1;padding:8px;border-radius:6px;border:1px solid #ccc}
    button{padding:8px 12px;margin-left:6px;border:none;border-radius:6px;background:#0078ff;color:#fff;cursor:pointer}
    #emergencyBtn{background:#d32f2f}
    /* Calculator style */
    #calculator{display:none;flex-direction:column;align-items:center;justify-content:center;flex:1;background:#222;padding:20px}
    #calc-display{width:80%;padding:10px;font-size:24px;text-align:right;border:none;border-radius:6px;margin-bottom:10px;background:#111;color:#fff}
    .calc-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;width:80%}
    .calc-buttons button{padding:15px;font-size:20px;border:none;border-radius:6px;background:#444;color:white;cursor:pointer}
    .calc-buttons button:hover{background:#555}
  </style>
</head>
<body>
  <!-- Calculator -->
  <div id="calculator">
    <input id="calc-display" readonly>
    <div class="calc-buttons">
      <button>7</button><button>8</button><button>9</button><button>/</button>
      <button>4</button><button>5</button><button>6</button><button>*</button>
      <button>1</button><button>2</button><button>3</button><button>-</button>
      <button>0</button><button>.</button><button id="calcEqual">=</button><button>+</button>
      <button id="calcClear">C</button>
    </div>
  </div>

  <!-- Chat -->
  <div id="chatContainer">
    <div id="onlineBox">Checking online...</div>
    <div id="lastSeen"></div>
    <div id="chatBox"></div>
    <div id="typing"></div>
    <div id="inputBox">
      <input id="messageInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
      <button id="clearBtn">Clear</button>
      <button id="emergencyBtn">ðŸš¨</button>
      <button id="toggleBtn">ðŸŒ™</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, update, onDisconnect, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBQmP2YgChWdkUyOyR5msGoog68KzNjDlk",
      authDomain: "chat-ab2b7.firebaseapp.com",
      databaseURL: "https://chat-ab2b7-default-rtdb.firebaseio.com",
      projectId: "chat-ab2b7",
      storageBucket: "chat-ab2b7.firebasestorage.app",
      messagingSenderId: "978470856109",
      appId: "1:978470856109:web:b8e64269b09ffd5225ed24"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const onlineBox = document.getElementById("onlineBox");
    const lastSeenDiv = document.getElementById("lastSeen");
    const chatBox = document.getElementById("chatBox");
    const typingDiv = document.getElementById("typing");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const emergencyBtn = document.getElementById("emergencyBtn");
    const toggleBtn = document.getElementById("toggleBtn");
    const calc = document.getElementById("calculator");
    const chatContainer = document.getElementById("chatContainer");
    const calcDisplay = document.getElementById("calc-display");

    let username = localStorage.getItem("username");
    if (!username) {
      username = prompt("Enter your name:") || "User" + Math.floor(Math.random() * 1000);
      localStorage.setItem("username", username);
    }

    // presence
    const presenceRef = ref(db, "presence/" + username);
    set(presenceRef, { online: true, lastSeen: serverTimestamp() });
    onDisconnect(presenceRef).set({ online: false, lastSeen: serverTimestamp() });

    // online / last seen display
    onValue(ref(db, "presence"), (snap) => {
      const data = snap.val() || {};
      const others = Object.keys(data).filter(n => n !== username);
      if (others.length > 0) {
        const other = others[0];
        const info = data[other];
        if (info.online) onlineBox.textContent = `${other} is online ðŸŸ¢`;
        else onlineBox.textContent = `${other} is offline ðŸ”´`;
        if (info.lastSeen) {
          const t = new Date(info.lastSeen);
          const timeStr = t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
          lastSeenDiv.textContent = `Last seen at ${timeStr}`;
        }
      } else {
        onlineBox.textContent = "Waiting for someone to join...";
        lastSeenDiv.textContent = "";
      }
    });

    // send message
    sendBtn.onclick = () => {
      const text = input.value.trim();
      if (!text) return;
      const msgRef = push(ref(db, "messages"));
      set(msgRef, {
        sender: username,
        text,
        ts: Date.now(),
        delivered: false,
        seen: false
      });
      input.value = "";
    };

    // receive + ticks
    onValue(ref(db, "messages"), (snap) => {
      const data = snap.val() || {};
      chatBox.innerHTML = "";
      for (const key in data) {
        const m = data[key];
        const div = document.createElement("div");
        div.className = "message" + (m.sender === username ? " self" : "");
        const time = new Date(m.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
        let ticks = "";
        if (m.sender === username) {
          if (m.seen) ticks = "ðŸ’™";
          else if (m.delivered) ticks = "âœ…âœ…";
          else ticks = "ðŸ•“";
        }
        div.innerHTML = `<strong>${m.sender}:</strong> ${m.text}<div class="meta">${time} ${ticks}</div>`;
        chatBox.appendChild(div);

        // mark delivered/seen
        if (m.sender !== username) update(ref(db, "messages/" + key), { delivered: true });
        if (document.visibilityState === "visible" && m.sender !== username)
          update(ref(db, "messages/" + key), { seen: true });
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    clearBtn.onclick = () => { chatBox.innerHTML = ""; localStorage.setItem("chatCleared", "true"); };

    emergencyBtn.onclick = () => {
      localStorage.clear();
      chatBox.innerHTML = "";
      chatContainer.style.display = "none";
      calc.style.display = "flex";
    };

    toggleBtn.onclick = () => {
      document.body.classList.toggle("dark");
      toggleBtn.textContent = document.body.classList.contains("dark") ? "â˜€ï¸" : "ðŸŒ™";
    };

    // Calculator logic
    let calcVal = "";
    const secretCode = "0304";
    document.querySelectorAll(".calc-buttons button").forEach(b => {
      b.onclick = () => {
        const val = b.textContent;
        if (val === "=") {
          if (calcVal === secretCode) {
            calc.style.display = "none";
            chatContainer.style.display = "flex";
          } else {
            try { calcDisplay.value = eval(calcVal); } catch { calcDisplay.value = "Error"; }
          }
          calcVal = "";
        } else if (val === "C") {
          calcVal = "";
          calcDisplay.value = "";
        } else {
          calcVal += val;
          calcDisplay.value = calcVal;
        }
      };
    });

    // always start in calculator
    window.addEventListener("load", () => {
      calc.style.display = "flex";
      chatContainer.style.display = "none";
    });
    window.addEventListener("beforeunload", () => {
      calc.style.display = "flex";
      chatContainer.style.display = "none";
    });
  </script>
</body>
</html>
