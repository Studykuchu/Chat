<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculatorr</title>
  <style>
    /* UI unchanged */
    *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
    body{background:#f4f4f4;display:flex;align-items:center;justify-content:center;min-height:100vh}
    #calculator{width:320px;padding:18px;background:#000;border-radius:16px;display:grid;grid-template-columns:repeat(4,1fr);grid-gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    #calc-display{grid-column:1/5;background:#111;color:#0f0;padding:14px;border-radius:10px;font-size:28px;text-align:right;min-height:56px;overflow:hidden}
    .btn{height:64px;border-radius:12px;border:none;background:#333;color:#fff;font-size:20px;cursor:pointer}
    .btn:hover{background:#444}
    .op{background:#ff9500}
    .op:hover{background:#ffa733}
    #equal{background:#0078ff}
    #clearCalc{background:#d32f2f}
    #chatContainer{display:none;width:360px;height:640px;border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.2);background:#fff;flex-direction:column}
    #onlineBox{background:#0078ff;color:#fff;padding:10px;font-size:14px}
    #lastSeen{padding:6px 10px;font-size:13px;color:#333;background:#f1f7ff}
    #chatBox{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#fafafa}
    .message{max-width:78%;padding:10px;border-radius:10px;background:#eee;align-self:flex-start;word-wrap:break-word;display:flex;flex-direction:column}
    .self{background:#0078ff;color:white;align-self:flex-end}
    .meta{font-size:11px;color:rgba(0,0,0,0.6);margin-top:6px;text-align:right}
    .ticks{margin-left:6px;font-size:12px;opacity:.85}
    #typing{padding:6px 12px;color:#666;font-size:13px;height:20px}
    #inputRow{display:flex;align-items:center;gap:6px;padding:8px;background:#fff;border-top:1px solid #eee;flex-wrap:nowrap}
    #messageInput{flex:1;padding:9px;border-radius:8px;border:1px solid #ccc;font-size:14px}
    #sendBtn,#clearBtn,#emergencyBtn{padding:9px 12px;border-radius:8px;border:none;background:#0078ff;color:#fff;cursor:pointer;flex-shrink:0}
    #clearBtn{background:#9e9e9e;color:#000}
    #emergencyBtn{background:#d32f2f;font-weight:bold}
    #attachBtn{background:#555;color:#fff;border:none;border-radius:8px;padding:9px;cursor:pointer}
    img.chat-img{max-width:200px;border-radius:8px;margin-top:4px;cursor:pointer;transition:transform .15s}
    img.chat-img:hover{transform:scale(1.03)}
    #imageFullscreen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);align-items:center;justify-content:center;z-index:1000;flex-direction:column}
    #imageFullscreen img{max-width:90%;max-height:85%;border-radius:12px;box-shadow:0 0 20px rgba(255,255,255,0.3)}
    #closeFullscreen{margin-top:20px;padding:10px 18px;border:none;border-radius:8px;background:#d32f2f;color:#fff;font-size:16px;cursor:pointer}
    @media(max-width:400px){#chatContainer{width:94vw;height:86vh}#calculator{width:94vw}}
  </style>
</head>
<body>

  <!-- Calculator -->
  <div id="calculator">
    <div id="calc-display"></div>
    <button class="btn">7</button><button class="btn">8</button><button class="btn">9</button><button class="btn op">/</button>
    <button class="btn">4</button><button class="btn">5</button><button class="btn">6</button><button class="btn op">*</button>
    <button class="btn">1</button><button class="btn">2</button><button class="btn">3</button><button class="btn op">-</button>
    <button class="btn">0</button><button class="btn">.</button><button class="btn" id="equal">=</button><button class="btn op">+</button>
    <button class="btn" id="clearCalc">C</button>
  </div>

  <!-- Chat -->
  <div id="chatContainer">
    <div id="onlineBox">Checking online...</div>
    <div id="lastSeen"></div>
    <div id="chatBox"></div>
    <div id="typing"></div>
    <div id="inputRow">
      <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
      <button id="attachBtn">ðŸ“Ž</button>
      <button id="sendBtn">Send</button>
      <button id="emergencyBtn">ðŸš¨</button>
      <button id="clearBtn">Clear</button>
    </div>
  </div>

  <!-- Fullscreen viewer -->
  <div id="imageFullscreen">
    <img id="fullscreenImg" src="" alt="Image">
    <button id="closeFullscreen">Exit Fullscreen</button>
  </div>

  <script type="module">
    /**************************************************************************
     * Single-file app with:
     * - presence fixed (accurate online / last seen)
     * - back button -> calculator
     * - minimize/tab hidden -> calculator + require retype
     * - all prior features unchanged
     **************************************************************************/

    // ---------- CONFIG ----------
    const IMGUR_CLIENT_ID = '546f1b2c3d4e5f6'; // replace with your Imgur client id for stability

    // Firebase imports (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, set, update, onDisconnect, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Firebase config (kept)
    const firebaseConfig = {
      apiKey: "AIzaSyBQmP2YgChWdkUyOyR5msGoog68KzNjDlk",
      authDomain: "chat-ab2b7.firebaseapp.com",
      databaseURL: "https://chat-ab2b7-default-rtdb.firebaseio.com/",
      projectId: "chat-ab2b7",
      storageBucket: "",
      messagingSenderId: "978470856109",
      appId: "1:978470856109:web:b8e64269b09ffd5225ed24"
    };

    // ---------- INIT ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM
    const calculator = document.getElementById('calculator');
    const calcDisplay = document.getElementById('calc-display');
    const buttons = calculator.querySelectorAll('.btn');
    const clearCalc = document.getElementById('clearCalc');

    const chatContainer = document.getElementById('chatContainer');
    const chatBox = document.getElementById('chatBox');
    const onlineBox = document.getElementById('onlineBox');
    const lastSeenDiv = document.getElementById('lastSeen');
    const typingDiv = document.getElementById('typing');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const attachBtn = document.getElementById('attachBtn');
    const clearBtn = document.getElementById('clearBtn');
    const emergencyBtn = document.getElementById('emergencyBtn');

    const imageFullscreen = document.getElementById('imageFullscreen');
    const fullscreenImg = document.getElementById('fullscreenImg');
    const closeFullscreen = document.getElementById('closeFullscreen');

    // hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    attachBtn.addEventListener('click', ()=> fileInput.click());

    // ---------- state ----------
    const SECRET = '0304';
    let calcValue = '';
    let username = localStorage.getItem('username');
    if (!username) {
      username = prompt('Enter your name:') || ('User' + Math.floor(Math.random()*999));
      localStorage.setItem('username', username);
    }
    let authUser = null;
    let listenersAttached = false;
    let heartbeatInterval = null;

    // ---------- helpers ----------
    function time12(ts) {
      const d = new Date(Number(ts));
      let h = d.getHours();
      const m = d.getMinutes().toString().padStart(2, '0');
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${m} ${ampm}`;
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // presence ref helper
    const presenceRefPath = () => 'presence/' + username;
    function setPresence(isOnline) {
      try {
        set(ref(db, presenceRefPath()), { online: !!isOnline, lastActive: serverTimestamp() }).catch(()=>{});
      } catch(e){ console.warn('setPresence failed', e); }
    }

    // ---------- Calculator logic ----------
    buttons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const v = btn.textContent;
        if (v === 'C') { calcValue=''; calcDisplay.textContent=''; return; }
        if (v === '=') {
          if (calcValue === SECRET) {
            // when unlocking, ensure presence online and attach listeners
            pushHistoryForChat(); // push history so back hides chat
            calculator.style.display = 'none';
            chatContainer.style.display = 'flex';
            setPresence(true);
            attachChatListeners();
            return;
          }
          try { calcValue = String(eval(calcValue)); calcDisplay.textContent = calcValue; }
          catch { calcDisplay.textContent = 'Error'; calcValue=''; }
          return;
        }
        calcValue += v;
        calcDisplay.textContent = calcValue;
      });
    });
    clearCalc.addEventListener('click', ()=>{ calcValue=''; calcDisplay.textContent=''; });

    // ---------- Auth (anonymous) ----------
    signInAnonymously(auth).catch(err => console.warn('Anonymous sign-in failed', err));
    onAuthStateChanged(auth, user => {
      if (user) {
        authUser = user;
        // set presence online while page active (we will adjust on visibilitychange)
        setPresence(true);
        // onDisconnect ensures correct state if browser/tab crashes or closed
        onDisconnect(ref(db, presenceRefPath())).set({ online: false, lastActive: serverTimestamp() }).catch(()=>{});
        // heartbeat to refresh lastActive every 20s while considered online
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        heartbeatInterval = setInterval(()=> {
          // only update lastActive when visible; if hidden, we set offline elsewhere
          if (!document.hidden) update(ref(db, presenceRefPath()), { lastActive: serverTimestamp() }).catch(()=>{});
        }, 20000);
      } else {
        authUser = null;
      }
    });

    // ---------- Attach listeners (presence, typing, messages) ----------
    function attachChatListeners(){
      if (listenersAttached) return;

      // PRESENCE
      onValue(ref(db,'presence'), snap => {
        const data = snap.val() || {};
        // filter out any empty or null keys (robust)
        const others = Object.keys(data).filter(k => k && k !== username);
        if (others.length === 0) {
          onlineBox.textContent = 'Waiting for someone...';
          lastSeenDiv.textContent = '';
          return;
        }
        const onlineNames = others.filter(n => data[n] && data[n].online);
        if (onlineNames.length) {
          onlineBox.textContent = 'ðŸŸ¢ Online: ' + onlineNames.join(', ');
          lastSeenDiv.textContent = '';
        } else {
          // pick the most recent lastActive among others
          let lastUser = null, lastTime = 0;
          for (const u of others) {
            const info = data[u];
            // handle serverTimestamp being an object or number
            const t = info && info.lastActive ? Number(info.lastActive) : 0;
            if (t > lastTime) { lastTime = t; lastUser = u; }
          }
          if (lastUser && lastTime > 0) {
            onlineBox.textContent = lastUser + ' is offline';
            lastSeenDiv.textContent = 'Last seen: ' + time12(lastTime);
          } else {
            onlineBox.textContent = 'No one online';
            lastSeenDiv.textContent = '';
          }
        }
      });

      // TYPING
      onValue(ref(db,'typing'), snap => {
        const t = snap.val() || {};
        const othersTyping = Object.keys(t).filter(k => k !== username && t[k]);
        typingDiv.textContent = othersTyping.length ? `${othersTyping.join(', ')} is typing...` : '';
      });

      // MESSAGES
      onValue(ref(db,'messages'), snap => {
        const data = snap.val() || {};
        chatBox.innerHTML = '';
        const clearedAt = Number(localStorage.getItem('clearedAt') || 0);
        const list = Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a,b)=> (a.ts||0)-(b.ts||0));
        for (const m of list) {
          if (!m) continue;
          if ((m.ts || 0) <= clearedAt) continue;
          const el = document.createElement('div');
          el.className = 'message' + (m.sender === username ? ' self' : '');
          let ticks = '';
          if (m.sender === username) {
            const seenCount = m.seenBy ? Object.keys(m.seenBy).filter(u=>u!==username).length : 0;
            if (seenCount > 0) ticks = 'ðŸ’™';
            else if (m.delivered) ticks = 'âœ“âœ“';
            else ticks = 'âœ“';
          }
          if (m.imageURL || m.imageData) {
            const src = m.imageURL || m.imageData;
            el.innerHTML = `<div><strong>${escapeHtml(m.sender)}:</strong><br><img src="${escapeHtml(src)}" class="chat-img"><div class="meta">${escapeHtml(m.time||'')} &nbsp;<span class="ticks">${ticks}</span></div></div>`;
          } else {
            el.innerHTML = `<div><strong>${escapeHtml(m.sender)}:</strong> ${escapeHtml(m.text||'')}<div class="meta">${escapeHtml(m.time||'')} &nbsp;<span class="ticks">${ticks}</span></div></div>`;
          }
          chatBox.appendChild(el);

          if (m.imageURL || m.imageData) {
            const img = el.querySelector('img');
            if (img) img.addEventListener('click', ()=> fullscreenOpen(m.imageURL || m.imageData));
          }
        }
        chatBox.scrollTop = chatBox.scrollHeight;

        // mark delivered and seen for messages from others
        for (const row of list) {
          if (!row) continue;
          if (row.sender !== username) {
            const msgRef = ref(db, 'messages/' + row.id);
            if (!row.delivered) update(msgRef, { delivered: true }).catch(()=>{});
            const seenBy = row.seenBy || {};
            if (!seenBy[username]) {
              const updateObj = {}; updateObj['seenBy/' + username] = true;
              update(msgRef, updateObj).catch(()=>{});
            }
          }
        }
      });

      listenersAttached = true;
    }

    function detachChatListeners(){
      off(ref(db,'presence'));
      off(ref(db,'typing'));
      off(ref(db,'messages'));
      listenersAttached = false;
    }

    // ---------- typing indicator push ----------
    let typingTimeout = null;
    messageInput.addEventListener('input', ()=>{
      set(ref(db,'typing/'+username), messageInput.value.trim() !== '').catch(()=>{});
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(()=> set(ref(db,'typing/'+username), false).catch(()=>{}), 1200);
    });

    // ---------- send message ----------
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    function sendMessage(){
      const text = messageInput.value.trim();
      if (!text) return;
      const msgRef = push(ref(db,'messages'));
      set(msgRef, {
        sender: username,
        text,
        ts: Date.now(),
        time: time12(Date.now()),
        delivered: false,
        seenBy: { [username]: true }
      }).catch(()=>{});
      messageInput.value = '';
      set(ref(db,'typing/'+username), false).catch(()=>{});
    }

    // ---------- robust Imgur upload + base64 fallback ----------
    function fileToDataURL(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = () => rej(new Error('FileReader failed'));
        r.readAsDataURL(file);
      });
    }

    async function tryImgurUploadOnce(file) {
      const fd = new FormData();
      fd.append('image', file);
      const resp = await fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: { Authorization: 'Client-ID ' + IMGUR_CLIENT_ID },
        body: fd
      });
      const json = await resp.json().catch(()=>null);
      if (!resp.ok) {
        throw new Error('Imgur non-OK: ' + resp.status + ' ' + JSON.stringify(json));
      }
      if (!json || !json.data || !json.data.link) throw new Error('Imgur unexpected response');
      return json.data.link;
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const maxBytes = 4 * 1024 * 1024; // 4MB
      if (file.size > maxBytes) {
        if (!confirm('Image is large (' + Math.round(file.size/1024) + ' KB). Upload may be slow. Continue?')) {
          e.target.value = '';
          return;
        }
      }

      console.log('Uploading image (Imgur -> fallback if needed)...', file.name, file.size);
      let imgUrl = null;
      try {
        try { imgUrl = await tryImgurUploadOnce(file); }
        catch (err1) { console.warn('Imgur first attempt failed:', err1); try { imgUrl = await tryImgurUploadOnce(file); } catch (err2) { console.warn('Imgur second attempt failed:', err2); imgUrl = null; } }

        if (imgUrl) {
          const msgRef = push(ref(db,'messages'));
          await set(msgRef, {
            sender: username,
            imageURL: imgUrl,
            ts: Date.now(),
            time: time12(Date.now()),
            delivered: false,
            seenBy: { [username]: true }
          });
          console.log('Image sent via Imgur:', imgUrl);
          e.target.value = '';
          return;
        }
      } catch (outerErr) {
        console.warn('Imgur flow error:', outerErr);
      }

      // FALLBACK: store base64 in DB
      try {
        const dataUrl = await fileToDataURL(file);
        const msgRef = push(ref(db,'messages'));
        await set(msgRef, {
          sender: username,
          imageData: dataUrl,
          ts: Date.now(),
          time: time12(Date.now()),
          delivered: false,
          seenBy: { [username]: true }
        });
        console.log('Fallback base64 image sent.');
      } catch (fallbackErr) {
        console.error('Fallback failed:', fallbackErr);
        alert('Image upload failed (Imgur + fallback). See console for details.');
      } finally {
        e.target.value = '';
      }
    });

    // ---------- fullscreen viewer ----------
    function fullscreenOpen(src){
      fullscreenImg.src = src;
      imageFullscreen.style.display = 'flex';
    }
    closeFullscreen.addEventListener('click', ()=> {
      imageFullscreen.style.display = 'none';
      fullscreenImg.src = '';
    });
    imageFullscreen.addEventListener('click', (ev) => {
      if (ev.target === imageFullscreen) {
        imageFullscreen.style.display = 'none';
        fullscreenImg.src = '';
      }
    });

    // ---------- clear & emergency ----------
    clearBtn.addEventListener('click', ()=> {
      localStorage.setItem('clearedAt', Date.now());
      chatBox.innerHTML = '';
    });

    emergencyBtn.addEventListener('click', ()=> {
      detachChatListeners();
      chatBox.innerHTML = '';
      chatContainer.style.display = 'none';
      calculator.style.display = 'grid';
      calcValue = ''; calcDisplay.textContent = '';
      // set presence offline because user "hid" chat intentionally
      setPresence(false);
      // push a history state to avoid immediate back reopening
      history.pushState({calculator:true}, '');
    });

    // ---------- history / back button handling ----------
    function pushHistoryForChat(){
      // push a state so pressing Back will pop it and we'll hide chat
      try { history.pushState({chat:true}, '', ''); } catch(e) {}
    }
    window.addEventListener('popstate', (e) => {
      // if chat is visible, hide it and show calculator (require retype)
      if (chatContainer.style.display === 'flex') {
        detachChatListeners();
        chatContainer.style.display = 'none';
        calculator.style.display = 'grid';
        calcValue = ''; calcDisplay.textContent = '';
        // set presence offline because user moved away
        setPresence(false);
      }
    });

    // ---------- visibility change (minimize/tab switch) ----------
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // hide chat and mark offline
        if (chatContainer.style.display === 'flex') {
          detachChatListeners();
          chatContainer.style.display = 'none';
          calculator.style.display = 'grid';
          calcValue = ''; calcDisplay.textContent = '';
        }
        setPresence(false);
      } else {
        // page became visible â€” keep calculator shown and require secret to reopen
        setPresence(true);
        // do NOT auto-open chat; user must re-enter secret
      }
    });

    // ensure presence false if user closes the tab (onbeforeunload won't always run but onDisconnect is set)
    window.addEventListener('beforeunload', ()=> {
      try { set(ref(db, presenceRefPath()), { online: false, lastActive: Date.now() }); } catch(e){ }
    });

    // title
    document.title = 'Calculatorr';
  </script>
</body>
</html>
