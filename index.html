<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <style>
    body {
      background: #121212;
      color: white;
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      margin: 0;
      padding: 0;
    }

    #chat-container {
      width: 90%;
      max-width: 500px;
      flex-grow: 1;
      background: #1e1e1e;
      border-radius: 15px;
      padding: 15px;
      margin-top: 20px;
      overflow-y: auto;
      box-shadow: 0 0 10px #000;
    }

    .message {
      background: #2a2a2a;
      margin: 5px 0;
      padding: 10px;
      border-radius: 10px;
    }

    .meta {
      font-size: 12px;
      color: gray;
    }

    #controls {
      width: 90%;
      max-width: 500px;
      display: flex;
      align-items: center;
      margin: 10px 0;
    }

    input {
      flex-grow: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      outline: none;
      background: #2a2a2a;
      color: white;
    }

    button {
      padding: 10px 15px;
      margin-left: 5px;
      border: none;
      border-radius: 10px;
      background: #3a3a3a;
      color: white;
      cursor: pointer;
    }

    #online {
      font-size: 13px;
      color: #00ff6a;
      margin-top: 10px;
    }

    #emergency {
      background: #ff3333;
      color: white;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="chat-container"></div>

  <div id="controls">
    <input type="text" id="messageInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
  </div>

  <div id="online">ðŸŸ¢ Checking online...</div>
  <button id="emergency" onclick="triggerEmergency()">ðŸš¨ Emergency</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ðŸš« Secure access check
    if (localStorage.getItem("accessGranted") !== "true") {
      window.location.href = "calculator.html";
    }

    // âœ… Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBqAN2xwhpH5kVybIeqbSkbZr1z7q5pEyQ",
      authDomain: "chat-room-secret.firebaseapp.com",
      databaseURL: "https://chat-room-secret-default-rtdb.firebaseio.com",
      projectId: "chat-room-secret",
      storageBucket: "chat-room-secret.appspot.com",
      messagingSenderId: "978470856109",
      appId: "1:978470856109:web:12345abcd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, "messages");
    const onlineRef = ref(db, "online");

    const chatContainer = document.getElementById("chat-container");
    const messageInput = document.getElementById("messageInput");
    const onlineStatus = document.getElementById("online");

    const username = localStorage.getItem("username") || prompt("Enter your name:");
    localStorage.setItem("username", username);

    // âœ… Mark user online
    const userRef = ref(db, `online/${username}`);
    set(userRef, true);
    onDisconnect(userRef).remove();

    // ðŸ” Redirect to calculator if back or reload
    window.addEventListener("popstate", () => {
      localStorage.removeItem("accessGranted");
      window.location.href = "calculator.html";
    });

    window.addEventListener("beforeunload", () => {
      localStorage.removeItem("accessGranted");
    });

    // âœ… Online users
    onValue(onlineRef, (snapshot) => {
      const users = snapshot.val();
      const onlineUsers = users ? Object.keys(users).join(", ") : "None";
      onlineStatus.textContent = `ðŸŸ¢ Online: ${onlineUsers}`;
    });

    // âœ… Load messages
    onValue(chatRef, (snapshot) => {
      chatContainer.innerHTML = "";
      const data = snapshot.val();
      if (data) {
        Object.values(data).forEach((msg) => {
          const div = document.createElement("div");
          div.classList.add("message");
          div.innerHTML = `<strong>${msg.name}:</strong> ${msg.text}<div class='meta'>${msg.time}</div>`;
          chatContainer.appendChild(div);
        });
      }
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });

    // âœ… Send message
    window.sendMessage = function() {
      const text = messageInput.value.trim();
      if (text === "") return;
      const now = new Date();
      const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      push(chatRef, { name: username, text, time });
      messageInput.value = "";
    };

    // âœ… Emergency
    window.triggerEmergency = function() {
      const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      push(chatRef, { name: "âš ï¸ SYSTEM", text: `${username} pressed EMERGENCY!`, time: now });
      remove(chatRef).then(() => {
        localStorage.removeItem("accessGranted");
        window.location.href = "calculator.html";
      });
    };
  </script>
</body>
</html>
