<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculatorr</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
    body{background:#f4f4f4;color:#222;min-height:100vh;display:flex;align-items:center;justify-content:center}
    #calculator{width:320px;padding:18px;background:#000;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:grid;grid-template-columns:repeat(4,1fr);grid-gap:10px}
    #calc-display{grid-column:1/5;background:#111;color:#0f0;padding:14px;border-radius:10px;font-size:28px;text-align:right;min-height:56px;overflow:hidden}
    .btn{height:64px;border-radius:12px;border:none;background:#333;color:#fff;font-size:20px;cursor:pointer}
    .btn:hover{background:#444}
    .op{background:#ff9500}
    .op:hover{background:#ffa733}
    #equal{background:#0078ff}
    #clearCalc{background:#d32f2f}
    #chatContainer{display:none;width:360px;height:640px;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2);background:#fff;flex-direction:column}
    #onlineBox{background:#0078ff;color:#fff;padding:10px;font-size:14px}
    #lastSeen{padding:6px 10px;font-size:13px;color:#333;background:#f1f7ff}
    #chatBox{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#fafafa}
    .message{max-width:78%;padding:10px;border-radius:10px;background:#eee;align-self:flex-start;word-wrap:break-word}
    .self{background:#0078ff;color:white;align-self:flex-end}
    .meta{font-size:11px;color:rgba(0,0,0,0.6);margin-top:6px;text-align:right}
    .ticks{margin-left:6px;font-size:12px;opacity:.85}
    #typing{padding:6px 12px;color:#666;font-size:13px;height:20px}
    #inputRow{display:flex;align-items:center;gap:6px;padding:8px;background:#fff;border-top:1px solid #eee;flex-wrap:nowrap}
    #messageInput{flex:1;padding:9px;border-radius:8px;border:1px solid #ccc;font-size:14px}
    #sendBtn,#clearBtn,#emergencyBtn{padding:9px 12px;border-radius:8px;border:none;background:#0078ff;color:#fff;cursor:pointer;flex-shrink:0}
    #clearBtn{background:#9e9e9e;color:#000}
    #emergencyBtn{background:#d32f2f;font-weight:bold}
    @media (max-width:400px){
      #chatContainer{width:94vw;height:86vh}
      #calculator{width:94vw}
      #inputRow{flex-wrap:wrap;gap:4px}
      #messageInput{width:100%}
    }
  </style>
</head>
<body>

  <!-- Calculator -->
  <div id="calculator">
    <div id="calc-display"></div>
    <button class="btn">7</button><button class="btn">8</button><button class="btn">9</button><button class="btn op">/</button>
    <button class="btn">4</button><button class="btn">5</button><button class="btn">6</button><button class="btn op">*</button>
    <button class="btn">1</button><button class="btn">2</button><button class="btn">3</button><button class="btn op">-</button>
    <button class="btn">0</button><button class="btn">.</button><button class="btn" id="equal">=</button><button class="btn op">+</button>
    <button class="btn" id="clearCalc">C</button>
  </div>

  <!-- Chat -->
  <div id="chatContainer">
    <div id="onlineBox">Checking online...</div>
    <div id="lastSeen"></div>
    <div id="chatBox"></div>
    <div id="typing"></div>
    <div id="inputRow">
      <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
      <button id="sendBtn">Send</button>
      <button id="clearBtn">Clear</button>
      <button id="emergencyBtn">ðŸš¨</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getDatabase, ref, push, onValue, set, update, onDisconnect, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBQmP2YgChWdkUyOyR5msGoog68KzNjDlk",
      authDomain: "chat-ab2b7.firebaseapp.com",
      databaseURL: "https://chat-ab2b7-default-rtdb.firebaseio.com/",
      projectId: "chat-ab2b7",
      storageBucket: "chat-ab2b7.firebasestorage.app",
      messagingSenderId: "978470856109",
      appId: "1:978470856109:web:b8e64269b09ffd5225ed24"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const calculator=document.getElementById('calculator');
    const calcDisplay=document.getElementById('calc-display');
    const buttons=calculator.querySelectorAll('.btn');
    const chatContainer=document.getElementById('chatContainer');
    const chatBox=document.getElementById('chatBox');
    const onlineBox=document.getElementById('onlineBox');
    const lastSeenDiv=document.getElementById('lastSeen');
    const typingDiv=document.getElementById('typing');
    const messageInput=document.getElementById('messageInput');
    const sendBtn=document.getElementById('sendBtn');
    const clearBtn=document.getElementById('clearBtn');
    const emergencyBtn=document.getElementById('emergencyBtn');

    const SECRET='0304'; let calcValue='';
    let username=localStorage.getItem('username');
    if(!username){
      username=prompt('Enter your name:')||('User'+Math.floor(Math.random()*999));
      localStorage.setItem('username',username);
    }

    function time12(ts){
      const d=new Date(ts);
      let h=d.getHours();
      const m=d.getMinutes().toString().padStart(2,'0');
      const ampm=h>=12?'PM':'AM';
      h=h%12||12;
      return `${h}:${m} ${ampm}`;
    }

    // --- Calculator logic ---
    buttons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        const v=btn.textContent;
        if(v==='C'){calcValue='';calcDisplay.textContent='';return;}
        if(v==='='){
          if(calcValue===SECRET){
            calculator.style.display='none';
            chatContainer.style.display='flex';
            document.title='Calculatorr';
            return;
          }
          try{calcValue=String(eval(calcValue));calcDisplay.textContent=calcValue;}
          catch{calcDisplay.textContent='Error';calcValue='';}
          return;
        }
        calcValue+=v;calcDisplay.textContent=calcValue;
      });
    });

    window.addEventListener('load',()=>{calculator.style.display='grid';chatContainer.style.display='none';});
    window.addEventListener('popstate',()=>{calculator.style.display='grid';chatContainer.style.display='none';});

    // --- Presence ---
    const presenceRef=ref(db,'presence/'+username);
    set(presenceRef,{online:true,lastActive:serverTimestamp()});
    onDisconnect(presenceRef).set({online:false,lastActive:serverTimestamp()});

    onValue(ref(db,'presence'),snap=>{
      const data=snap.val()||{};
      const others=Object.keys(data).filter(k=>k!==username);
      if(others.length===0){onlineBox.textContent='Waiting for someone...';lastSeenDiv.textContent='';return;}
      let onlineNames=[], latestOffline=null, latestTime=0;
      others.forEach(u=>{
        if(data[u]?.online) onlineNames.push(u);
        else if(data[u]?.lastActive && data[u].lastActive>latestTime){
          latestOffline=u; latestTime=data[u].lastActive;
        }
      });
      if(onlineNames.length>0){
        onlineBox.textContent='ðŸŸ¢ Online: '+onlineNames.join(', ');
        lastSeenDiv.textContent='';
      }else if(latestOffline){
        onlineBox.textContent=latestOffline+' is offline';
        lastSeenDiv.textContent='Last seen: '+time12(latestTime);
      }
    });

    // --- Typing ---
    let typingTimeout=null;
    messageInput.addEventListener('input',()=>{
      set(ref(db,'typing/'+username),true);
      if(typingTimeout)clearTimeout(typingTimeout);
      typingTimeout=setTimeout(()=>set(ref(db,'typing/'+username),false),1200);
    });

    onValue(ref(db,'typing'),snap=>{
      const t=snap.val()||{};
      const othersTyping=Object.keys(t).filter(u=>u!==username&&t[u]);
      typingDiv.textContent=othersTyping.length?`${othersTyping.join(', ')} is typing...`:'';
    });

    // --- Messaging ---
    sendBtn.addEventListener('click',sendMessage);
    messageInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage();});
    function sendMessage(){
      const text=messageInput.value.trim();
      if(!text)return;
      const msgRef=push(ref(db,'messages'));
      set(msgRef,{sender:username,text,ts:Date.now(),time:time12(Date.now()),delivered:false,seenBy:{[username]:true}});
      messageInput.value='';set(ref(db,'typing/'+username),false);
    }

    onValue(ref(db,'messages'),snap=>{
      const data=snap.val()||{};
      chatBox.innerHTML='';
      const keys=Object.keys(data).sort((a,b)=>(data[a].ts||0)-(data[b].ts||0));
      for(const k of keys){
        const m=data[k];
        const el=document.createElement('div');
        el.className='message'+(m.sender===username?' self':'');
        let ticks='';
        if(m.sender===username){
          const seenCount=m.seenBy?Object.keys(m.seenBy).filter(u=>u!==username).length:0;
          if(seenCount>0)ticks='ðŸ’™';else if(m.delivered)ticks='âœ“âœ“';else ticks='âœ“';
        }
        el.innerHTML=`<div><strong>${m.sender}:</strong> ${m.text}</div><div class="meta">${m.time||''}<span class="ticks">${ticks}</span></div>`;
        chatBox.appendChild(el);
      }
      chatBox.scrollTop=chatBox.scrollHeight;
      for(const k of keys){
        const m=data[k];
        if(m.sender!==username){
          if(!m.delivered)update(ref(db,'messages/'+k),{delivered:true});
          if(!m.seenBy||!m.seenBy[username])set(ref(db,'messages/'+k+'/seenBy/'+username),true);
        }
      }
    });

    // --- Clear & Emergency ---
    clearBtn.addEventListener('click',()=>{localStorage.setItem('clearedAt',Date.now());chatBox.innerHTML='';});
    emergencyBtn.addEventListener('click',()=>{
      localStorage.setItem('clearedAt',Date.now());
      chatBox.innerHTML='';
      chatContainer.style.display='none';
      calculator.style.display='grid';
      window.open('https://www.google.com/search?q=calculator','_blank');
    });

    document.title='Calculatorr';
  </script>
</body>
</html>
